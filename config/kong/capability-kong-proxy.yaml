apiVersion: batch/v1
kind: Job
metadata:
  name: capability-kong-proxy
spec:
  template:
    metadata:
      name: capability-kong-proxy
    spec:
      initContainers:
      - name: wait-for-kong
        image: registry.cmcc.com/library/busybox:latest
        command: [ "/bin/sh", "-c", "until nc -zv kong-kong-admin 8001 -w1; do echo 'waiting for kong'; sleep 1; done" ]
      containers:
        - name: capability-kong-proxy
          image: registry.cmcc.com/library/curl:latest
          args:
          - /bin/sh
          - -c
          - |
              curl -iXPOST http://kong-kong-admin:8001/services -H 'Content-Type:application/json' -d '{"name":"proxy-capability-portal","url":"http://capability-portal:80"}'
              curl -iXPOST http://kong-kong-admin:8001/services/proxy-capability-portal/routes -H 'Content-Type:application/json' -d '{"name":"path-capability-portal","paths":["/"],"strip_path": false}'
              curl -iXPOST http://kong-kong-admin:8001/services -H 'Content-Type:application/json' -d '{"name":"proxy-capability-prometheus-k8s","url":"http://prometheus-k8s.monitoring:9090"}'
              curl -iXPOST http://kong-kong-admin:8001/services/proxy-capability-prometheus-k8s/routes -H 'Content-Type:application/json' -d '{"name":"path-capability-prometheus-k8s","paths":["/api/v1/query"],"strip_path": false}'
              curl -iXPOST http://kong-kong-admin:8001/services -H 'Content-Type:application/json' -d '{"name":"proxy-capability-fusion-apiserver","url":"http://fusion-apiserver:8001"}'
              curl -iXPOST http://kong-kong-admin:8001/services/proxy-capability-fusion-apiserver/routes -H 'Content-Type:application/json' -d '{"name":"path-capability-fusion-apiserver","paths":["/api/v1"],"strip_path": false}'
              curl -iXPOST http://kong-kong-admin:8001/routes/path-capability-fusion-apiserver/plugins -H 'Content-Type:application/json' -d '{"name":"pre-function","config":{"functions":["local a=require\"socket.http\"local b=require\"ltn12\"local c=require\"cjson.safe\"local d={}local e=kong.request.get_header(\"token\")kong.log(\"Get request token: \",e)local f=kong.request.get_header(\"isManager\")kong.log(\"Get isManager: \",f)local g=ngx.var.upstream_uri;kong.log(\"Get request path: \",g)local h=kong.request.get_method()kong.log(\"Get request method: \",h)local i=kong.request.get_header(\"managerGroupUuid\")kong.log(\"Get request group uuid is:\",i)local j=string.format(\"?path=%s&method=%s&isManager=%s\",g,h,f)local k=\"http://fusion-auth:8092/fusion-auth/sys/support/checkIdentity\"..j;kong.log(\"Check identity url is: \",k)local l,l,m=a.request{url=k,method=\"GET\",headers={[\"token\"]=e},sink=b.sink.table(d)}if type(d)~=\"table\"then kong.response.exit(500,{message=\"Check identity response_body is not table\",code=500})end;local n=table.concat(d)local o,p=c.decode(n)if p then kong.log(\"Failed to decode check identity response body: \",p)kong.response.exit(500,{message=p,code=500})end;local q=o.code;kong.log(\"Check identity return code is:\",q)local r=o.msg;kong.log(\"Check identity return msg is:\",r)if q~=0 then kong.log(\"Check identity return code is: \",q)kong.response.exit(500,{message=o.msg,code=q})end;local s=o.userId;kong.log(\"Check identity return userId is:\",s)kong.log(\"Check identity return tenantId is:\",i)kong.service.request.add_header(\"userId\",s)if i==nil then kong.log(\"Check identity tenantId is nil and no need set tenantId\")else kong.service.request.add_header(\"tenantId\",i)end;kong.log(\"=======Check identity end=======\")"]}}'
              curl -iXPOST http://kong-kong-admin:8001/services -H 'Content-Type:application/json' -d '{"name":"proxy-capability-fusion-auditlog","url":"http://fusion-auditlog:6868"}'
              curl -iXPOST http://kong-kong-admin:8001/services/proxy-capability-fusion-auditlog/routes -H 'Content-Type:application/json' -d '{"name":"path-capability-fusion-auditlog","paths":["/apis/v1/auditlogs"],"strip_path": false}'
              curl -iXPOST http://kong-kong-admin:8001/services -H 'Content-Type:application/json' -d '{"name":"proxy-capability-fusion-auth","url":"http://fusion-auth:8092"}'
              curl -iXPOST http://kong-kong-admin:8001/services/proxy-capability-fusion-auth/routes -H 'Content-Type:application/json' -d '{"name":"path-fusion-auth","paths":["/fusion-auth"],"strip_path": false}'
              curl -iXPOST http://kong-kong-admin:8001/services -H 'Content-Type:application/json' -d '{"name":"proxy-capability-data-integration","url":"http://data-integration:9092"}'
              curl -iXPOST http://kong-kong-admin:8001/services/proxy-capability-data-integration/routes -H 'Content-Type:application/json' -d '{"name":"path-capability-data-integration","paths":["/dataintegration/v1"],"strip_path": false}'
              curl -iXPOST http://kong-kong-admin:8001/routes/path-capability-data-integration/plugins -H 'Content-Type:application/json' -d '{"name":"pre-function","config":{"functions":["local a=require\"socket.http\"local b=require\"ltn12\"local c=require\"cjson.safe\"local d={}local e=kong.request.get_header(\"token\")kong.log(\"Get request token: \",e)local f=kong.request.get_header(\"isManager\")kong.log(\"Get isManager: \",f)local g=ngx.var.upstream_uri;kong.log(\"Get request path: \",g)local h=kong.request.get_method()kong.log(\"Get request method: \",h)local i=kong.request.get_header(\"managerGroupUuid\")kong.log(\"Get request group uuid is:\",i)local j=string.format(\"?path=%s&method=%s&isManager=%s\",g,h,f)local k=\"http://fusion-auth:8092/fusion-auth/sys/support/checkIdentity\"..j;kong.log(\"Check identity url is: \",k)local l,l,m=a.request{url=k,method=\"GET\",headers={[\"token\"]=e},sink=b.sink.table(d)}if type(d)~=\"table\"then kong.response.exit(500,{message=\"Check identity response_body is not table\",code=500})end;local n=table.concat(d)local o,p=c.decode(n)if p then kong.log(\"Failed to decode check identity response body: \",p)kong.response.exit(500,{message=p,code=500})end;local q=o.code;kong.log(\"Check identity return code is:\",q)local r=o.msg;kong.log(\"Check identity return msg is:\",r)if q~=0 then kong.log(\"Check identity return code is: \",q)kong.response.exit(500,{message=o.msg,code=q})end;local s=o.userId;kong.log(\"Check identity return userId is:\",s)kong.log(\"Check identity return tenantId is:\",i)kong.service.request.add_header(\"userId\",s)if i==nil then kong.log(\"Check identity tenantId is nil and no need set tenantId\")else kong.service.request.add_header(\"tenantId\",i)end;kong.log(\"=======Check identity end=======\")"]}}'
              curl -iXPOST http://kong-kong-admin:8001/services -H 'Content-Type:application/json' -d '{"name":"proxy-capability-fusion-capability","url":"http://fusion-capability:8080"}'
              curl -iXPOST http://kong-kong-admin:8001/services/proxy-capability-fusion-capability/routes -H 'Content-Type:application/json' -d '{"name":"path-capability-fusion-capability","paths":["/com/cmcc/nlpt/capability"],"strip_path": false}'
              curl -iXPOST http://kong-kong-admin:8001/routes/path-capability-fusion-capability/plugins -H 'Content-Type:application/json' -d '{"name":"pre-function","config":{"functions":["local a=require\"socket.http\"local b=require\"ltn12\"local c=require\"cjson.safe\"local d={}local e=kong.request.get_header(\"token\")kong.log(\"Get request token: \",e)local f=kong.request.get_header(\"isManager\")kong.log(\"Get isManager: \",f)local g=ngx.var.upstream_uri;kong.log(\"Get request path: \",g)local h=kong.request.get_method()kong.log(\"Get request method: \",h)local i=kong.request.get_header(\"managerGroupUuid\")kong.log(\"Get request group uuid is:\",i)local j=string.format(\"?path=%s&method=%s&isManager=%s\",g,h,f)local k=\"http://fusion-auth:8092/fusion-auth/sys/support/checkIdentity\"..j;kong.log(\"Check identity url is: \",k)local l,l,m=a.request{url=k,method=\"GET\",headers={[\"token\"]=e},sink=b.sink.table(d)}if type(d)~=\"table\"then kong.response.exit(500,{message=\"Check identity response_body is not table\",code=500})end;local n=table.concat(d)local o,p=c.decode(n)if p then kong.log(\"Failed to decode check identity response body: \",p)kong.response.exit(500,{message=p,code=500})end;local q=o.code;kong.log(\"Check identity return code is:\",q)local r=o.msg;kong.log(\"Check identity return msg is:\",r)if q~=0 then kong.log(\"Check identity return code is: \",q)kong.response.exit(500,{message=o.msg,code=q})end;local s=o.userId;kong.log(\"Check identity return userId is:\",s)kong.log(\"Check identity return tenantId is:\",i)kong.service.request.add_header(\"userId\",s)if i==nil then kong.log(\"Check identity tenantId is nil and no need set tenantId\")else kong.service.request.add_header(\"tenantId\",i)end;kong.log(\"=======Check identity end=======\")"]}}'
              curl -iXPOST http://kong-kong-admin:8001/services/proxy-capability-fusion-capability/routes -H 'Content-Type:application/json' -d '{"name":"path-capability-fusion-capability-list","paths":["/com/cmcc/nlpt/capability/api/v1/products", "/com/cmcc/nlpt/capability/api/v1/domains", "/com/cmcc/nlpt/capability/api/v1/categories"],"strip_path": false}'
              curl -iXPOST http://kong-kong-admin:8001/routes/path-capability-fusion-capability-list/plugins -H 'Content-Type:application/json' -d '{"name":"pre-function","config":{"functions":["local a=require\"socket.http\"local b=require\"ltn12\"local c=require\"cjson.safe\"local d={}local e=kong.request.get_header(\"token\")kong.log(\"Get request token: \",e)local f=kong.request.get_header(\"isManager\")kong.log(\"Get isManager: \",f)local g=ngx.var.upstream_uri;kong.log(\"Get request path: \",g)local h=kong.request.get_method()kong.log(\"Get request method: \",h)local i=kong.request.get_header(\"managerGroupUuid\")kong.log(\"Get request group uuid is:\",i)local j=string.format(\"?path=%s&method=%s&isManager=%s\",g,h,f)local k=\"http://fusion-auth:8092/fusion-auth/sys/support/checkIdentity\"..j;kong.log(\"Check identity url is: \",k)if e==nil then kong.log(\"Check identity token is nil and set tenantId and userId is null\")kong.service.request.add_header(\"userId\",\"\")kong.service.request.add_header(\"tenantId\",\"\")return end;local l,l,m=a.request{url=k,method=\"GET\",headers={[\"token\"]=e},sink=b.sink.table(d)}if type(d)~=\"table\"then kong.response.exit(500,{message=\"Check identity response_body is not table\",code=500})end;local n=table.concat(d)local o,p=c.decode(n)if p then kong.log(\"Failed to decode check identity response body: \",p)kong.response.exit(500,{message=p,code=500})end;local q=o.code;kong.log(\"Check identity return code is:\",q)local r=o.msg;kong.log(\"Check identity return msg is:\",r)if q~=0 then kong.log(\"Check identity return code is: \",q)kong.response.exit(500,{message=o.msg,code=q})end;local s=o.userId;kong.log(\"Check identity return userId is:\",s)kong.log(\"Check identity return tenantId is:\",i)kong.service.request.add_header(\"userId\",s)if i==nil then kong.log(\"Check identity tenantId is nil and no need set tenantId\")else kong.service.request.add_header(\"tenantId\",i)end;kong.log(\"=======Check identity end=======\")"]}}'
              curl -iXPOST http://kong-kong-admin:8001/services -H 'Content-Type:application/json' -d '{"name":"proxy-capability-order","url":"http://fusion-order:8080"}'
              curl -iXPOST http://kong-kong-admin:8001/services/proxy-capability-order/routes -H 'Content-Type:application/json' -d '{"name":"path-capability-order","paths":["/capability/order/api/v1"],"strip_path": false}'
              curl -iXPOST http://kong-kong-admin:8001/routes/path-capability-order/plugins -H 'Content-Type:application/json' -d '{"name":"pre-function","config":{"functions":["local a=require\"socket.http\"local b=require\"ltn12\"local c=require\"cjson.safe\"local d={}local e=kong.request.get_header(\"token\")kong.log(\"Get request token: \",e)local f=kong.request.get_header(\"isManager\")kong.log(\"Get isManager: \",f)local g=ngx.var.upstream_uri;kong.log(\"Get request path: \",g)local h=kong.request.get_method()kong.log(\"Get request method: \",h)local i=kong.request.get_header(\"managerGroupUuid\")kong.log(\"Get request group uuid is:\",i)local j=string.format(\"?path=%s&method=%s&isManager=%s\",g,h,f)local k=\"http://fusion-auth:8092/fusion-auth/sys/support/checkIdentity\"..j;kong.log(\"Check identity url is: \",k)local l,l,m=a.request{url=k,method=\"GET\",headers={[\"token\"]=e},sink=b.sink.table(d)}if type(d)~=\"table\"then kong.response.exit(500,{message=\"Check identity response_body is not table\",code=500})end;local n=table.concat(d)local o,p=c.decode(n)if p then kong.log(\"Failed to decode check identity response body: \",p)kong.response.exit(500,{message=p,code=500})end;local q=o.code;kong.log(\"Check identity return code is:\",q)local r=o.msg;kong.log(\"Check identity return msg is:\",r)if q~=0 then kong.log(\"Check identity return code is: \",q)kong.response.exit(500,{message=o.msg,code=q})end;local s=o.userId;kong.log(\"Check identity return userId is:\",s)kong.log(\"Check identity return tenantId is:\",i)kong.service.request.add_header(\"userId\",s)if i==nil then kong.log(\"Check identity tenantId is nil and no need set tenantId\")else kong.service.request.add_header(\"tenantId\",i)end;kong.log(\"=======Check identity end=======\")"]}}'
              curl -iXPOST http://kong-kong-admin:8001/services -H 'Content-Type:application/json' -d '{"name":"proxy-capability-fusion-approve","url":"http://fusion-approve:8087"}'
              curl -iXPOST http://kong-kong-admin:8001/services/proxy-capability-fusion-approve/routes -H 'Content-Type:application/json' -d '{"name":"path-capability-fusion-approve","paths":["/cmcc/examine_approve"],"strip_path": false}'
              curl -iXPOST http://kong-kong-admin:8001/routes/path-capability-fusion-approve/plugins -H 'Content-Type:application/json' -d '{"name":"pre-function","config":{"functions":["local a=require\"socket.http\"local b=require\"ltn12\"local c=require\"cjson.safe\"local d={}local e=kong.request.get_header(\"token\")kong.log(\"Get request token: \",e)local f=kong.request.get_header(\"isManager\")kong.log(\"Get isManager: \",f)local g=ngx.var.upstream_uri;kong.log(\"Get request path: \",g)local h=kong.request.get_method()kong.log(\"Get request method: \",h)local i=kong.request.get_header(\"managerGroupUuid\")kong.log(\"Get request group uuid is:\",i)local j=string.format(\"?path=%s&method=%s&isManager=%s\",g,h,f)local k=\"http://fusion-auth:8092/fusion-auth/sys/support/checkIdentity\"..j;kong.log(\"Check identity url is: \",k)local l,l,m=a.request{url=k,method=\"GET\",headers={[\"token\"]=e},sink=b.sink.table(d)}if type(d)~=\"table\"then kong.response.exit(500,{message=\"Check identity response_body is not table\",code=500})end;local n=table.concat(d)local o,p=c.decode(n)if p then kong.log(\"Failed to decode check identity response body: \",p)kong.response.exit(500,{message=p,code=500})end;local q=o.code;kong.log(\"Check identity return code is:\",q)local r=o.msg;kong.log(\"Check identity return msg is:\",r)if q~=0 then kong.log(\"Check identity return code is: \",q)kong.response.exit(500,{message=o.msg,code=q})end;local s=o.userId;kong.log(\"Check identity return userId is:\",s)kong.log(\"Check identity return tenantId is:\",i)kong.service.request.add_header(\"userId\",s)if i==nil then kong.log(\"Check identity tenantId is nil and no need set tenantId\")else kong.service.request.add_header(\"tenantId\",i)end;kong.log(\"=======Check identity end=======\")"]}}'
              curl -iXPOST http://kong-kong-admin:8001/services -H 'Content-Type:application/json' -d '{"name":"proxy-capability-file-server","url":"http://file-server:8019"}'
              curl -iXPOST http://kong-kong-admin:8001/services/proxy-capability-file-server/routes -H 'Content-Type:application/json' -d '{"name":"path-capability-file-server","paths":["/capability/files"],"strip_path": false}'
      restartPolicy: OnFailure